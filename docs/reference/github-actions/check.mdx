---
title: Ensure Main is Ready for Merge
description: GitHub Actions workflow for validating main branch status and migration readiness
---

# Ensure Main is Ready for Merge

This workflow validates that the main branch is in a ready state for merging pull requests. It checks the migration status and ensures no pending migrations are running that could affect the merge process.

## Workflow Configuration

```yaml
name: Ensure Main is Ready for Merge

on:
  pull_request:
    ignore-branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 3
  XATA_API_REFRESH_TOKEN: ${{ secrets.XATA_API_REFRESH_TOKEN }}
  XATA_API_ENVIRONMENT: staging
  XATA_ORGANIZATIONID: 123xyz
  XATA_PROJECTID: prj_i3qsq56h3p3d3crnk7htnc75d0
  XATA_BRANCHID: s99l2grl6d3nr1cqcbaaa5piic
  XATA_BRANCHNAME: main
  XATA_DATABASENAME: app

jobs:
  xata-dev-branch:
    name: Xata Dev Branch
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Install Xata CLI
        run: |
          curl -fsSL https://xata.io/install.sh | bash
          echo "/home/runner/.config/xata/bin" >> $GITHUB_PATH
      - name: Check Xata Status
        run: |
          xata status
          xata roll status
          xata branch view
      - name: Check Xata main branch pgroll status
        id: xata-main-branch-roll-status
        run: |
          xata roll status | jq -r '.status'
          echo XATA_MAIN_BRANCH_ROLL_STATUS=`xata roll status | jq -r '.status'` >> $GITHUB_OUTPUT
      - name: Complete Any Pending Migrations (inherited from main)
        if: ${{ steps.xata-main-branch-roll-status.outputs.XATA_MAIN_BRANCH_ROLL_STATUS == 'In progress' }}
        run: |
          echo "Warning: A migration is currently running on the main branch. Please wait for it to complete before merging this PR."
          exit 1
```

## Authentication and Environment Variables

The workflow requires several environment variables to be set:

- `XATA_API_REFRESH_TOKEN`: Your Xata API refresh token (set as a GitHub secret)
- `XATA_API_ENVIRONMENT`: The Xata environment to use (e.g., staging)
- `XATA_ORGANIZATIONID`: Your Xata organization ID
- `XATA_PROJECTID`: Your Xata project ID
- `XATA_BRANCHID`: The ID of the main branch
- `XATA_BRANCHNAME`: The name of the main branch
- `XATA_DATABASENAME`: Your database name

## Workflow Steps

### 1. Install Xata CLI

```yaml
- name: Install Xata CLI
  run: |
    curl -fsSL https://xata.io/install.sh | bash
    echo "/home/runner/.config/xata/bin" >> $GITHUB_PATH
```

This step installs the Xata CLI using the official installer script and adds it to the GitHub Actions PATH.

### 2. Check Xata Status

```yaml
- name: Check Xata Status
  run: |
    xata status
    xata roll status
    xata branch view
```

This step performs three checks:
- Verifies CLI and connection status
- Checks the current migration status
- Views branch information

For more details, see:
- [status command documentation](../cli/status.mdx)
- [roll status command documentation](../cli/roll.mdx#status)
- [branch view command documentation](../cli/branch.mdx#view)

### 3. Check Main Branch Migration Status

```yaml
- name: Check Xata main branch pgroll status
  id: xata-main-branch-roll-status
  run: |
    xata roll status | jq -r '.status'
    echo XATA_MAIN_BRANCH_ROLL_STATUS=`xata roll status | jq -r '.status'` >> $GITHUB_OUTPUT
```

This step:
- Checks the migration status of the main branch
- Extracts the status using `jq`
- Stores the status in a step output variable for conditional execution

### 4. Handle Pending Migrations

```yaml
- name: Complete Any Pending Migrations (inherited from main)
  if: ${{ steps.xata-main-branch-roll-status.outputs.XATA_MAIN_BRANCH_ROLL_STATUS == 'In progress' }}
  run: |
    echo "Warning: A migration is currently running on the main branch. Please wait for it to complete before merging this PR."
    exit 1
```

This step:
- Runs only if a migration is in progress on main
- Prevents merging by failing the workflow
- Provides a clear warning message

## Concurrency Control

The workflow uses GitHub Actions concurrency to prevent multiple runs from interfering with each other:

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

This ensures that:
- Only one workflow run per branch is active at a time
- New runs cancel any in-progress runs
- Prevents race conditions during status checks

## When to Use

Use this workflow when you want to:
- Ensure main branch is ready for merging
- Prevent merging during active migrations
- Validate branch and migration status
- Maintain database consistency

## Best Practices

1. **Set Appropriate Timeout**
   - The workflow has a 10-minute timeout
   - Adjust based on your typical migration duration

2. **Use Environment Variables**
   - Store sensitive information in GitHub secrets
   - Use environment variables for configuration

3. **Handle Migration States**
   - Check for in-progress migrations
   - Prevent merging during active migrations
   - Provide clear error messages

## Related Workflows

- [Clone Workflow](./clone.mdx) - For cloning databases in CI/CD
- [PR Workflow](./pr.mdx) - For managing pull request environments 