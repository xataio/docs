---
title: CI pipelines
---

## Introduction

Xata makes it possible to do zero downtime schema migration. Let's see that end to end with an example using GitHub actions in a pull request workflow. 

## Xata CLI Setup

Start by creating a [Xata](https://xata.io) account (contact us) and downloading the Xata CLI using

```bash
curl -fsSL https://xata.io/install.sh | bash
```

Login to your [Xata](https://xata.io) account with the CLI.

```bash
$ xata auth login
```

Create a project

```bash
$ xata project create --name "Awesome Task List"
Using organization MyOrganization
Project my-awesome-app created with id prj_**************************.
```

Connect a folder to a xata project using

```bash
$ xata init
```

```bash
xata project init
âœ” Select an organization Â· MyOrganization
âœ” Select a project Â· prj_********************
Wrote project config to /Users/divyendusingh/Xata-Code/playground/pgroll/examples/.maki/project.json. The following details were written
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Organization ID â”‚ Project ID                     â”‚ Branch ID                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123xyz          â”‚ prj_************************** â”‚ ************************** â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜%
```

<aside>
ğŸ’¡

Note: All that `xata init` command does is create a folder with the following structure

*$ cat .xata/project.json
{
  "organizationId": "*MyOrganization*",
  "projectId": "*prj_************************** *",
  "branchId": "****************************"
}*

All xata commands refer to `organizationId`, `projectId` and `branchId` from this configuration file, so they don't have to be specified.

This step is optional, alternative is to provide the --organization (and other) flags with each command that needs these values OR use env vars like `XATA_ORGANIZATION_ID`. When running Xata CLI in a non CI environment, you will be prompted to pick the required values from the current logged in account.

</aside>

Check if everything is working correctly

```bash
$ xata status
```

It should have the following expected output

```bash
$ xata status
Current project config based on /Users/divyendusingh/Xata-Code/playground/pgroll/examples/.xata/project.json:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Organization â”‚ Project                                              â”‚ Branch                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123xyz       â”‚ Awesome Task List (prj_**************************)   â”‚ main (**************************) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

xata roll status
{
  "schema": "public",
  "version": "",
  "status": "No migrations"
}

CLI versions:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Xata CLI â”‚ pgroll â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1.0.2    â”‚ 0.9.0  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<aside>
ğŸ’¡

Xata status is a single command to show the current status of the whole xata project. It outputs 

- Current connected project via `.xata/project.json` OR environment variables
- If any schema migrations are running via pgroll (i.e. `xata roll status`)
- Versions of the xata and pgroll binaries

`pgroll` is our open source offering that Xata CLI uses internally to help with zero downtime migration, checkout [pgroll.com](https://pgroll.com) for more information.

</aside>

You can see all the branches in a project with tree command

```bash
$ xata branch tree --show-id
â””â”€ main (id: fam04ch3a92irfvfqmq137dlek)
```

You can setup pgroll on the project with

```bash
$ xata roll init
```

You can drop into the `psql` shell by running

```bash
$ psql `xata branch url`
```

Then create a table using the following SQL, we will use it later.

```sql
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    done BOOLEAN DEFAULT FALSE,
    assignee TEXT
);
```

Now that we have the xata CLI correctly setup, let's proceed to setting up Github Actions.

## Actions Setup

Here is the scenario that we want to try out in this tutorial.

You start with a database with the following schema and a version v1 of an application that writes the tasks. Assuming this is the current state of the database (from the last step).

```sql
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    done BOOLEAN DEFAULT FALSE,
    assignee TEXT
);
```

But you want to evolve this schema and add a constraint such that the assignee can only have the following values 'Alice' and 'Bob'. Note that this is a simple yet breaking change and a already bit tricky to do in a zero downtime way.

Because as we add the constraint the v1 of the application will break as it allows users to add free text. What we want to achieve is a way where v1 and v2 versions of the application can co-exist for as long as we want (till we rollout all nodes of v1 to v2) and then do a cutoff to update the schema. 

The `pgroll` migration to add this constraint is the following

```json
{
  "name": "02_check_assignee",
  "operations": [
    {
      "alter_column": {
        "table": "items",
        "column": "assignee",
        "check": { "name": "items_assignee_check", "constraint": "assignee IN ('alice', 'bob')" }
      },
      "up": "(SELECT CASE WHEN assignee in ('alice', 'bob') THEN assignee ELSE 'alice' END)",
      "down": "assignee"
    }
  ]
}
```

Let's start writing a GitHub Action that would operate in a PR and do the following:

- The pgroll migration above is part of the pull request (written by the user)
    
    <aside>
    ğŸ’¡
    
    Note: to integrate with any existing ORMs / migration tools that emit an SQL, you can also use the following command to convert a migration SQL to its equivalent pgroll JSON file.
    
    $ xata roll convert migration.sql
    
    </aside>
    
- In the GitHub action that executes on the pull request, we want to
    - download the xata CLI an authenticate it (via `XATA_CLI_REFRESH_TOKEN`)
    - link the action to a project via env vars
    - create a xata branch (that will be clone of the main branch) and checkout that branch
    - execute the pgroll migration against the branch, perform tests (manual and automatic)
    - once happy with the change and testing, merge the PR
        - this would start another action that would run the pgroll migration in production

We will use the following commands from Xata CLI in the GitHub action. 

```bash
$ xata branch create --name "${{ github.head_ref }}"
Name: feat_task_assignee
Parent Branch Id: **************************%
```

```bash
$ xata branch checkout "${{ github.head_ref }}"
Switched to branch feat_task_assignee
```

```bash
$ xata roll migrate
```

To get the `XATA_API_REFRESH_TOKEN` for the CI, please use the following command

```yaml
$ xata auth refresh-token
***token_gets_printed***
```

This is how the complete GitHub Actions `pr.yaml` file looks like

```yaml
name: Create Xata Dev Branch

on:
  pull_request:
    ignore-branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 3
  XATA_API_REFRESH_TOKEN: ${{ secrets.XATA_API_REFRESH_TOKEN }}
  XATA_ORGANIZATIONID: ${{ secrets.XATA_ORGANIZATIONID }}
  XATA_PROJECTID: ${{ secrets.XATA_PROJECTID }}
  XATA_BRANCHID: ${{ secrets.XATA_BRANCHID }}
  XATA_BRANCHNAME: ${{ secrets.XATA_BRANCHNAME }}
  XATA_DATABASENAME: ${{ secrets.XATA_DATABASENAME }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

permissions:
  id-token: write
  contents: write
  packages: write
  pages: write
  pull-requests: write

jobs:
  xata-dev-branch:
    name: Xata Dev Branch
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Find Previous Comment
        id: find-comment
        uses: peter-evans/find-comment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Xata Dev Branch"

      - uses: actions/checkout@v4
        with:
          # This makes Actions fetch all Git history so that Changesets can generate changelogs with the correct commits
          fetch-depth: 0
          # This makes the PR pushed to use GITHUB_TOKEN and trigger the checks
          persist-credentials: false

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install Xata CLI
        run: |
          curl -fsSL https://xata.io/install.sh | bash
          echo "/home/runner/.config/xata/bin" >> $GITHUB_PATH

      # TODO(alternate-checkout)
      # - name: Initialize Xata
      #   run: xata init --organization ${{ secrets.XATA_ORGANIZATIONID }} --project ${{ secrets.XATA_PROJECTID }} --branch ${{ secrets.XATA_BRANCHID }}

      - name: Check Xata Status
        run: |
          xata status
          xata roll status
          xata branch view

      - name: Check Xata main branch pgroll status
        id: xata-main-branch-roll-status
        run: |
          echo XATA_MAIN_BRANCH_ROLL_STATUS=`xata roll status | jq -r '.status'` >> $GITHUB_OUTPUT

      - name: Create or Update Comment
        id: create_comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ### Xata Dev Branch

            Creating Xata Dev Branch for commit: ${{ github.sha }} / ${{ github.head_ref }}_${{ github.event.pull_request.number }}
            ${{ steps.xata-main-branch-roll-status.outputs.XATA_MAIN_BRANCH_ROLL_STATUS == 'In progress' && 'Warning: A migration is currently running on the main branch. Please wait for it to complete before merging this PR.' || '' }}

            *Please wait for the comment to be updated with branch details.*

      - name: Delete Any Existing Xata Dev Branch
        run: xata branch delete ${{ github.head_ref }}_${{ github.event.pull_request.number }} --yes
        continue-on-error: true

      - name: Create Xata Dev Branch
        run: xata branch create --name ${{ github.head_ref }}_${{ github.event.pull_request.number }}

      # TODO(alternate-checkout)
      # - name: Checkout Xata Dev Branch
      #   run: |
      #     xata branch checkout ${{ github.head_ref }}_${{ github.event.pull_request.number }}

      - name: Checkout Xata Dev Branch
        run: |
          echo XATA_BRANCHID=`xata branch checkout ${{ github.head_ref }}_${{ github.event.pull_request.number }} --json | jq -r '.id'` >> $GITHUB_ENV

      - name: Check Xata Branch Status
        run: xata branch view

      - name: Wait for Branch to be healthy
        run: xata branch wait-ready ${{ github.head_ref }}_${{ github.event.pull_request.number }}

      - name: Complete Any Pending Migrations (interited from main)
        if: ${{ steps.xata-main-branch-roll-status.outputs.XATA_MAIN_BRANCH_ROLL_STATUS == 'In progress' }}
        run: |
          xata roll complete

      # TODO(long-backfills): What about backfills that take much longer? (probably not for MVP)
      # we might have to split migrate and backfill and use checks API to block the PR until the backfill is done
      - name: Apply Xata Roll Migrations
        run: xata roll migrate

      # TODO(search-path-preview): setup search path with the preview URL
      # TODO(search-path-preview-via-main): setup search path with the preview URL for the main branch (to test the main branch to confirm zero downtime)
      # TODO(search-path-production): setup search path with the production URL after merge
      - name: Get Latest Schema
        id: xata-roll-get-latest-schema
        run: |
          echo LATEST_SCHEMA=`xata roll latest --with-schema=true` >> $GITHUB_OUTPUT

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        working-directory: ./app
        run: vercel pull --yes --environment=preview --token=${{ env.VERCEL_TOKEN }}

      - name: Setup New Preview Environment
        working-directory: ./app
        run: |
          echo DATABASE_URL=`xata branch url` >> $GITHUB_ENV
          echo SEARCH_PATH=${{ steps.xata-roll-get-latest-schema.outputs.LATEST_SCHEMA }} >> $GITHUB_ENV

      - name: Build Project Artifacts
        working-directory: ./app
        run: vercel build --token=${{ env.VERCEL_TOKEN }}

      - name: Print Environment Variables
        run: |
          echo DATABASE_URL=${{ env.DATABASE_URL }}
          echo SEARCH_PATH=${{ env.SEARCH_PATH }}

      - name: Deploy Preview to Vercel
        id: deploy
        working-directory: ./app
        run: |
          echo PREVIEW_URL=$(vercel deploy --prebuilt \
            --yes \
            --token=${{ env.VERCEL_TOKEN }} \
            -e DATABASE_URL=${{ env.DATABASE_URL }} \
            -b DATABASE_URL=${{ env.DATABASE_URL }} \
            -e SEARCH_PATH=${{ env.SEARCH_PATH }} \
            -b SEARCH_PATH=${{ env.SEARCH_PATH }}
          )
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Update Comment with Branch Details
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ### Xata Dev Branch

            Created Xata Dev Branch for commit: ${{ github.sha }} / ${{ github.head_ref }}_${{ github.event.pull_request.number }}
            ${{ steps.xata-main-branch-roll-status.outputs.XATA_MAIN_BRANCH_ROLL_STATUS == 'In progress' && 'Warning: A migration is currently running on the main branch. Please wait for it to complete before merging this PR.' || '' }}

            Set the following schemas as the search_path:
            ```
            ${{ steps.xata-roll-get-latest-schema.outputs.LATEST_SCHEMA }}
            ```

            You can drop into the psql shell for this branch with the following command:
            ```
            xata branch checkout ${{ github.head_ref }}_${{ github.event.pull_request.number }}
            psql `xata branch url`
            ```

            | Vercel Preview URL | Xata Branch URL |
            |---|---|
            | [App Link](${{ steps.deploy.outputs.preview_url }}) | [Branch Link](https://console.xata.io/organizations/${{ secrets.XATA_ORGANIZATIONID }}/projects/${{ secrets.XATA_PROJECTID }}/branches/${{ env.XATA_BRANCHID }}) |
```